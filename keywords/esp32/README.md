# Lab 1, Part 2: Building a Keyword Spotter Application for Seeed Studio XIAO ESP32-S3 Sense

In this second part of the lab, you will install the toolchain for building ESP32 applications, then build and flash the Keyword Spotter to your board and try it out for yourself.

The application code consists of several files in the `main` folder:
 * `CMakeLists.txt`: This file lists the C and C++ source files to include in the application.
 * `idf_component.yml`: This file lists the libraries that the application depends on. In this case, it's the library `esp-tflite-micro`, which is a fork of the standard TensorFlow Lite Micro (TFLM) library with adaptations for utilizing the hardware acceleration available on ESP32 chips.
    * *NOTE: This file should normally not be edited manually - it's managed by the `idf.py` tool, which will be described below.*
 * `main.cpp`: The main application source file with its two main functions `setup()` and `loop()`:
    * `setup()` initializes inference and preprocessing, runs the pipeline test, and finally initializes the audio driver and the LED.
    * `loop()` repeatedly reads a short audio clip and pushes it to the preprocessor, and when a complete one-second spectrogram is available, it runs inference and lights up or turns off the LED if "yes" or "no" was detected.
 * `audio.cpp`: The microphone audio driver, providing short (512 samples) audio clips in real time.
 * `preprocess.cpp`: The audio preprocessor, which runs signal processing (Fourier transform etc) and buffers spectral frames in a circle buffer to provide complete one-second spectrograms.
 * `inference.cpp`: The neural network inference engine, which quantizes the input data, runs inference with the TFLM interpreter, and dequantizes the output.
 * `model.c`: The neural network model binary data, generated by the Python script in the [previous part of this lab](../python/README.md).
 * `test.cpp`: The pipeline test runner, which is run once on setup to check equivalence between the Python and C++ preprocessing and inference pipelines.

*NOTE: The following instructions assume that you will be using [VS Code](https://code.visualstudio.com/download) as your code editor and that you have installed it already. However, many developers prefer [Arduino IDE](https://www.arduino.cc/en/software/) for developing ESP32 applications. If you're more comfortable with Arduino IDE, you're welcome to use it instead - however, we haven't tested this project with Arduino IDE, and we may not be able to help you if you get stuck.*

## Prerequisites

 * Assemble the board according to [Getting Started with Seeed Studio XIAO ESP32S3 Series - Hardware Preparation](https://wiki.seeedstudio.com/xiao_esp32s3_getting_started/#hardware-preparation).
 * Install [VS Code](https://code.visualstudio.com/download). If you're new to VS Code, I recommend going through their [Getting Started tutorial](https://code.visualstudio.com/docs/getstarted/getting-started) to get acquainted with the editor.
 * Complete [Part 1 of this lab](../python/README.md).

## 1. Install the VS Code C/C++ extension

In VS Code, install the `C/C++` extension from Microsoft, if you don't already have it.

## 2. Install ESP-IDF

ESP-IDF (Espressif IoT Development Framework) is the complete set of tools needed to build and flash applications written in C++ for an ESP32-based device. Since you will work extensively with ESP-IDF throughout the course, it's well worth the time to spend some time exploring the documentation at https://docs.espressif.com and getting acquainted with the framework. Note that the entire framework takes up approximately 13 GB on your drive.
 * For Windows, install ESP-IDF according to the following instructions: https://docs.espressif.com/projects/esp-idf/en/stable/esp32s3/get-started/windows-setup.html
    - When asked for an ESP-IDF installation folder, choose `C:\Users\<your-user-name>\esp\esp-idf`.
    - When asked for a tools installation folder, choose `C:\Users\<your-user-name>\.espressif`.
    - When asked for components, choose a custom instalation with at least:
        - Frameworks
        - PowerShell or Command Prompt (whichever you prefer)
        - Espressif (WinUSB support for JTAG)
        - ESP32-S3 chip target
    - *NOTE: ESP-IDF can't follow paths with spaces, so if your user name contains spaces, you'll need to choose other folders.*
 * For Mac and Linux, install ESP-IDF according to the following instructions: https://docs.espressif.com/projects/esp-idf/en/stable/esp32s3/get-started/linux-macos-setup.html

## 3. Configure VS Code for ESP-IDF

*NOTE: The VS Code Marketplace also has an `ESP-IDF` extension, which helps with the following configuration. However, unfortunately, it also does much more than that, and my experience with this extension has not been great. For this reason, this section describes a minimal manual setup for VS Code IntelliSense and a terminal with all necessary commands.*

1. Open the folder `labs/keywords/esp32` in VS Code. If you open a C++ file like `main/main.cpp`, you will see error squiggles in the code. After proper configuration and a successful build, these error squiggles will disappear.
2. Open VS Code `settings.json` for your user (`Ctrl/Command+Shift+P` and type `Preferences: Open User Settings (JSON)` (WSL users type `Preferences: Open Remote Settings (JSON)`) and add the following lines the existing JSON object (between the outer `{}`)):
    * For Windows:
        ```json
        "idf.espIdfPathWin": "C:/Users/<your-user-name>/esp/esp-idf",
        "idf.toolsPathWin": "C:/Users/<your-user-name>/.espressif",
        ```
    * For Mac and Linux:
        ```json
        "idf.espIdfPath": "${env:HOME}/esp/esp-idf",
        "idf.toolsPath": "${env:HOME}/.espressif",
        ```
3. Under `labs/keywords/esp32`, create a file `.vscode/c_cpp_properties.json` and paste the following content:
    * For Windows:
        ```json
        {
          "configurations": [
            {
              "name": "ESP-IDF",
              "compilerPath": "${config:idf.toolsPathWin}\\tools\\xtensa-esp-elf\\esp-14.2.0_20251107\\xtensa-esp-elf\\bin\\xtensa-esp32s3-elf-gcc.exe",
              "compileCommands": "${workspaceFolder}/build/compile_commands.json",
              "includePath": [
                "${workspaceFolder}/**",
                "${config:idf.espIdfPathWin}/components/**"
              ],
              "browse": {
                "path": [
                  "${workspaceFolder}",
                  "${config:idf.espIdfPathWin}/components/**"
                ],
                "limitSymbolsToIncludedHeaders": false
              }
            }
          ],
          "version": 4
        }
        ```
    * For Mac and Linux:
        ```json
        {
          "configurations": [
            {
              "name": "ESP-IDF",
              "compilerPath": "${config:idf.toolsPath}/tools/xtensa-esp-elf/esp-14.2.0_20251107/xtensa-esp-elf/bin/xtensa-esp32s3-elf-gcc",
              "compileCommands": "${workspaceFolder}/build/compile_commands.json",
              "includePath": [
                "${workspaceFolder}/**",
                "${config:idf.espIdfPath}/components/**"
              ],
              "browse": {
                "path": [
                  "${workspaceFolder}",
                  "${config:idf.espIdfPath}/components/**"
                ],
                "limitSymbolsToIncludedHeaders": false
              }
            }
          ],
          "version": 4
        }
        ```
    * *NOTE: The above compiler paths assume that you have installed ESP-IDF version 5.5.2, which was the latest stable version at the time of writing. If you have installed another version, you will need to find the correct path to the compiler executable and adjust the `"compilerPath"` entry.*
4. Also create a file `.vscode/settings.json` with the following content (You may need to change the python's version number in IDF_PYTHON_ENV_PATH based on your installed python):
    * For Windows:
        ```json
        {
          "terminal.integrated.profiles.windows": {
            "ESP-IDF (cmd)": {
              "path": "C:\\Windows\\System32\\cmd.exe",
              "args": ["/k", "${config:idf.espIdfPathWin}/export.bat"],
              "env": {
                "IDF_PYTHON_ENV_PATH": "${config:idf.toolsPathWin}/python_env/idf5.5_py3.11_env"
              }
            }
          },
          "terminal.integrated.defaultProfile.windows": "ESP-IDF (cmd)"
        }
        ```
    * For Mac:
        ```json
        {
          "terminal.integrated.profiles.osx": {
            "ESP-IDF (zsh)": {
              "path": "/bin/zsh",
              "args": ["-lc", "source ${config:idf.espIdfPath}/export.sh && exec zsh -l"],
              "env": {
                "IDF_PYTHON_ENV_PATH": "${config:idf.toolsPath}/python_env/idf5.5_py3.11_env"
              }
            }
          },
          "terminal.integrated.defaultProfile.osx": "ESP-IDF (zsh)"
        }
        ```
    * For Linux:
        ```json
        {
          "terminal.integrated.profiles.linux": {
            "ESP-IDF (bash)": {
              "path": "/bin/bash",
              "args": ["-lc", "source ${config:idf.espIdfPath}/export.sh && exec bash -l"],
              "env": {
                "IDF_PYTHON_ENV_PATH": "${config:idf.toolsPath}/python_env/idf5.5_py3.11_env"
              }
            }
          },
          "terminal.integrated.defaultProfile.linux": "ESP-IDF (bash)"
        }
        ```
5. Open a terminal in VS Code. Verify that it activates the ESP-IDF environment - you should see some progress output ending with:
    ```
    Done! You can now compile ESP-IDF projects.
    Go to the project directory and run:       

      idf.py build
    ```
6. Enter `idf.py --help` to see the available commands. `idf.py` is an executable application that will be your main entry point to most ESP-IDF tasks. Take some time to check the documentation for the following useful commands:
 * `idf.py build`
 * `idf.py flash monitor`
 * `idf.py add-dependency`
 * `idf.py reconfigure`
 * `idf.py clean` and `idf.py fullclean`

## 4. Build the application

In the ESP-IDF terminal, enter `idf.py build` to build the project. It may take several minutes the first time.

## 5. Flash and run the application

1. Connect the board to your computer with a USB-C cable. Verify that the red LED lights up (as it always does for 30 seconds on connection).
2. In the ESP-IDF terminal, enter `idf.py flash monitor` to flash and run the application on the board. After the application has started, you should see output like this:
    ```
    I (1164) Inference: Amplitude:   130, Other: 0.90, Yes: 0.01, No: 0.09
    I (1534) Inference: Amplitude:   144, Other: 0.99, Yes: 0.00, No: 0.01
    ...
    ```
3. Verify that the yellow LED lights up when you say "yes" and that it turns off when you say "no". You should also see the probabilities for the three classes change.
4. Stop the monitor by pressing `Ctrl/Command+]` (depending on your keyboard, it may be a different key - try `Ctrl+¨` or `Ctrl+Å`).
